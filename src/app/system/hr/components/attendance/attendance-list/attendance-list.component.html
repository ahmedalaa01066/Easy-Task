<div class="candidates-table-container">

    <!-- Top Controls (Search + Filters) Attendance-->
    <div class="top-controls" *ngIf="isAttendanceTab">
        <!-- Search Box -->
        <div class="search-wrapper">
            <span class="pi pi-search search-icon"></span>
            <input type="text" placeholder="Search for candidates" [(ngModel)]="attendanceSearchText"
                (ngModelChange)="loadAttendance()" />
        </div>

        <!-- Filter Buttons -->
        <div class="filter-buttons">
            <p-button label="Today" styleClass="filter-btn" (click)="filterBy('today')"></p-button>
            <p-button label="This Week" styleClass="filter-btn" (click)="filterBy('thisWeek')"></p-button>
            <p-button label="Last Week" styleClass="filter-btn" (click)="filterBy('lastWeek')"></p-button>
            <p-button label="Last 2 Weeks" styleClass="filter-btn" (click)="filterBy('last2Weeks')"></p-button>
            <!-- <p-button label="Filters" styleClass="filter-btn">
    <img src="../../../../../../assets/images/Filters lines.png">
  </p-button> -->
        </div>

    </div>

    <!-- Top Controls (Search + Filters) isCandidatesAssignationTab-->
    <div class="top-controls" *ngIf="isCandidatesAssignationTab">
        <!-- Search Box -->
        <div class="search-wrapper">
            <span class="pi pi-search search-icon"></span>
            <input type="text" placeholder="Search for candidates, Shift Name" [(ngModel)]="assignationSearchText"
                (ngModelChange)="loadCandidatesAssignation()" />
        </div>
    </div>

    <!-- Table Header -->
    <div class="table-header">
        <h3 class="table-title">All candidates</h3>
        <!-- <p-button *ngIf="isAttendanceTab" icon="pi pi-upload" label="Upload Fingerprint"
            styleClass="upload-btn"></p-button> -->
        <p-button *ngIf="isCandidatesAssignationTab" label="Assign Candidate" styleClass="assginCandidate-btn"
            (click)="openAssignCandidate()"></p-button>

    </div>

    <!-- Attendance Table -->
    <p-table *ngIf="isAttendanceTab" [value]="attendanceRecords" [rows]="50" [showCurrentPageReport]="true"
        [currentPageReportTemplate]="'Page {currentPage} of {totalPages}'" styleClass="candidates-table"
        [tableStyle]="{ 'min-width': '70rem' }">
        <!-- Header -->
        <ng-template pTemplate="header">
            <tr>
                <th>All Candidates</th>

                <ng-container *ngIf="attendanceRecords.length > 0">
                    <ng-container *ngFor="let ws of attendanceRecords[0].weeklyStatuses">
                        <th>
                            <div>{{ ws.dayName }}</div>
                            <div class="header-date">{{ ws.date }}</div>
                        </th>
                    </ng-container>
                </ng-container>



                <th></th>
            </tr>
        </ng-template>

        <!-- Body -->
        <ng-template pTemplate="body" let-record>
            <tr>
                <td>
                    <div class="candidate-cell">
                        <div class="candidate-name">{{ record.name }}</div>
                        <div class="candidate-dept">{{ record.departmentName }}</div>
                    </div>
                </td>

                <!-- الحالات حسب الأيام -->
                <ng-container *ngFor="let day of getDays(record)">
                    <td>
                        <span [ngClass]="getStatusClass(day.status)">
                            {{getStatusName(day.status) }}
                        </span>
                    </td>
                </ng-container>


                <td class="action-cell">
                    <p-button styleClass="attend-btn" (click)="goToAttendDetails(record.id)">Attend Details</p-button>
                    <img src="../../../../../../assets/images/edit.png" alt="edit" class="action-icon" />
                </td>
            </tr>
        </ng-template>

        <!-- Empty State -->
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="100%" class="empty-message">
                    <div class="empty-state">
                        <i class="pi pi-calendar-times empty-icon"></i>
                        <p>No attendance records found</p>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>


    <!-- Candidates Assignation Table -->
    <p-table *ngIf="isCandidatesAssignationTab" [value]="assignationRecords" [rows]="50" [showCurrentPageReport]="true"
        [currentPageReportTemplate]="'Page {currentPage} of {totalPages}'" styleClass="candidates-table">

        <ng-template pTemplate="header">
            <tr>
                <th>Candidate</th>
                <th>Shift Assigned</th>
                <th>Attendance Activation</th>
                <th></th>
            </tr>
        </ng-template>


        <ng-template pTemplate="body" let-record>
            <tr>
                <td>
                    <div class="candidate-cell">
                        <div class="candidate-name">{{ record.name }}</div>
                        <div class="candidate-dept">{{ record.department }}</div>
                    </div>
                </td>
                <td>{{ record.shift }}</td>
                <td>{{ record.activation }}</td>
                <td class="action-cell">

                    <p-button label="Attend Details" styleClass="attend-btn" (click)="goToAttendDetails(record.id)">
                    </p-button>
                    <img src="../../../../../../assets/images/edit.png" alt="edit" class="action-icon">
                </td>
            </tr>
        </ng-template>
    </p-table>
    <div class="pagination-wrapper" *ngIf="isAttendanceTab">
        <span class="page-info">Page {{ shiftsPageNumber }} of {{ shiftsTotalPages }}</span>
        <div class="page-controls">
            <p-button styleClass="page-btn" (click)="shiftsPrevious()"
                [disabled]="shiftsPageNumber === 1">Previous</p-button>
            <p-button styleClass="page-btn" (click)="shiftsNext()"
                [disabled]="shiftsPageNumber >= shiftsTotalPages">Next</p-button>
        </div>
    </div>
    <div class="pagination-wrapper" *ngIf="isCandidatesAssignationTab">
        <span class="page-info">Page {{ assignationPageNumber }} of {{ assignationTotalPages }}</span>
        <div class="page-controls">
            <p-button styleClass="page-btn" (click)="assignationPrevious()"
                [disabled]="assignationPageNumber === 1">Previous</p-button>
            <p-button styleClass="page-btn" (click)="assignationNext()"
                [disabled]="assignationPageNumber >= assignationTotalPages">Next</p-button>
        </div>
    </div>

</div>

<p-dialog [(visible)]="showAssignDialog" [modal]="true" [closable]="true" [draggable]="false" [resizable]="false"
    styleClass="add-candidate-dialog" header="Assign Candidate" [style]="{ width: '600px', minHeight: '550px' }">

    <div class="candidate-form">

        <!-- Departments -->
        <!-- Departments -->
        <div class="form-field">
            <label for="departments">Select Departments<span class="error-message">*</span></label>
            <p-multiSelect [(ngModel)]="selectedDepartments" [options]="departments" optionLabel="label"
                optionValue="value" display="chip" placeholder="Select department"
                class="form-input dropdown-input w-100" [filter]="true" [filterBy]="'label'" [showToggleAll]="false"
                (onChange)="loadCandidatesByDepartmentIds(selectedDepartments)">
            </p-multiSelect>
        </div>

        <!-- Candidates -->
        <div class="form-field py-3">
            <label for="candidateIds">Select Candidates<span class="error-message">*</span></label>
            <p-multiSelect [(ngModel)]="selectedCandidates" [options]="candidates" optionLabel="label"
                optionValue="value" display="chip" placeholder="Select Candidates" [filter]="true" [filterBy]="'label'"
                [showToggleAll]="false" class="form-input dropdown-input w-100">
            </p-multiSelect>
        </div>

        <!-- Shifts -->
        <div class="form-field">
            <label for="shiftId">Select Shift<span class="error-message">*</span></label>
            <p-dropdown [(ngModel)]="selectedShift" [options]="shifts" optionLabel="label" optionValue="value"
                placeholder="Select Shift" class="form-input dropdown-input w-100">
            </p-dropdown>
        </div>


        <!-- Dates -->
        <div class="form-row py-3">
            <div class="form-field">
                <label for="startDate">Start date<span class="error-message">*</span></label>
                <p-calendar [(ngModel)]="startDate" placeholder="DD-MM-YYYY" dateFormat="dd-mm-yy" appendTo="body"
                    [showIcon]="true" iconDisplay="input" class="form-input calendar-input" [minDate]="today"
                    (onSelect)="validateDates()">
                </p-calendar>
                <div *ngIf="startDateError" class="error-message">{{ startDateError }}</div>
            </div>

            <div class="form-field">
                <label for="endDate">End date<span class="error-message">*</span></label>
                <p-calendar [(ngModel)]="endDate" placeholder="DD-MM-YYYY" dateFormat="dd-mm-yy" appendTo="body"
                    [showIcon]="true" iconDisplay="input" class="form-input calendar-input" [minDate]="startDate"
                    (onSelect)="validateDates()">
                </p-calendar>
                <div *ngIf="endDateError" class="error-message">{{ endDateError }}</div>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <ng-template pTemplate="footer">
        <div class="dialog-footer">
            <p-button label="Cancel" [text]="true" severity="secondary" (onClick)="showAssignDialog = false"
                class="cancel-btn">
            </p-button>

            <p-button label="Save" styleClass="p-button-sm p-button-success" (click)="saveAssignation()"
                [disabled]="!isFormValid()">
            </p-button>

        </div>
    </ng-template>
</p-dialog>